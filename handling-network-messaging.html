<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Handling network messaging - Archers! Development Blog</title>
	<meta name="description" content="Few thoughts on client-server interaction in a multiplayer, web-based game. Optimization of the Web Sockets traffic using schema-based binary protocol">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="css/archers.css?v=1389869109024" rel="stylesheet" media="all">
	<!--[if lt IE 9]><script src="js/html5shiv-printshiv.js" media="all"></script><![endif]-->
</head>
<body>
	<nav role="navigation" class="post-menu">
		<h2>All Posts</h2><button class="close">&times;</button>
		<ul>
			
			<li>
				
				
					<a href="/development-screenshots-2.html">Development screenshots 2</a>
				
			</li>
			
			<li>
				
				
					<a href="/development-screenshots.html">Development screenshots</a>
				
			</li>
			
			<li>
				
				
					<a href="/customized-characters.html">Customized characters</a>
				
			</li>
			
			<li>
				
				
					<a href="/dynamic-sprite-coloring.html">Dynamic sprite coloring</a>
				
			</li>
			
			<li>
				
				
					<a href="/character-customization.html">Character customization</a>
				
			</li>
			
			<li>
				
				
					<a href="/feedback-analysis.html">Feedback Analysis</a>
				
			</li>
			
			<li>
				
				
					<a href="/alpha-tests.html">Alpha Tests!</a>
				
			</li>
			
			<li>
				
				
					<a href="/works-on-mobiles-too.html">Works on mobiles too!</a>
				
			</li>
			
			<li>
				
				
					<a href="/first-working-version.html">First working version</a>
				
			</li>
			
			<li>
				
					Handling network messaging
				
				
			</li>
			
			<li>
				
				
					<a href="/backend-in-python.html">Backend in Python</a>
				
			</li>
			
			<li>
				
				
					<a href="/searching-for-a-frontend-engine.html">Searching for a front end engine</a>
				
			</li>
			
			<li>
				
				
					<a href="/dynamic-multiplayer-online-game.html">Dynamic multiplayer online game</a>
				
			</li>
			
		</ul>
	</nav>
	<div class="pre-footer-wrapper">
		<header role="banner">
			<button class="menu">Browse Posts</button>
			<button class="menu small-screen">&nbsp;</button>
			<a href="/">
				<img src="/img/logo.svg" alt="Archers Logo"><h1>Archers! - Development Blog</h1>
			</a>
		</header>
		<div class="wrap">
			<main role="main">
				<h1>
				<span>Handling network messaging</span><time datetime="Fri Jun 14 2013 01:00:00 GMT+0100 (BST)">14 Jun 2013</time>
				</h1>
				<article>
				 	

<p>I've came up with some basic rules on how to implement the networking for my multiplayer, web-based game:</p>

<ul>
	<li>Server always has the most up-to-date state of the game</li>
	<li>Real-time communication is sent over Web Sockets</li>
	<li>Physics, collisions etc. happens only on the server side, client just gets dummy position updates. This might not work for a dynamic, 3D FPS but will do just fine for a 2D action game</li>
	<li>Don't do anything too clever on the front end. It should render the output and relay the input.</li>
	<li>Never trust the client, verify all data coming from the client and discard anything that doesn't check out</li>
	<li>Very small frames containing only relevant changes in a compacted form will be sent the clients as often as feasible. Initially aiming for 20 frames a second</li>
	<li>Larger updates containing state of the game or info about new player joining sent as required to the clients - still in a compacted form</li>
	<li>Meta information (e.g. player name change, game score) sent in a separate message as rarely as possible (this messages will be larger) </li>
	<li>Client sends compact messages based on user input (move/attack etc.) and meta messages (change character name) as required</li>
	<li>To make the experience smoother, client might do some extrapolation (predicting the movement) or interpolation (drawing movement between 2 frames). This will require further research.</li>
</ul>

<p>As you can see above, I would like to use compact messages for the most common client-server traffic. I would like to use just few bytes of data per frame and luckily Web Sockets specification allows for sending binary data. It's a relatively new feature but is supported by all the modern browsers (Chrome 15+, Firefox 11+, Internet Explorer 10, and Safari nightly). Luckily my back end framework (Autobahn) is capable of sending and receiving binary messages over Web Socket.</p>

<p>To keep the message size to the minimum, I've devised a schema-based, binary protocol. Client and server will need a small JSON file listing all the possible messages as well as details on how to read/build each individual message. For example a simple frame message would consist of four unsigned integers, first representing message id (so that decoder can pull up correct schema), second and third representing X and Y coordinates of the character and fourth representing unique character id. Since each integer requires 4 bytes, the frame message as specified above would require a total of 16 bytes. Much less than the equivalent message sent as JSON.</p>

<p>So instead of this:</p>

<pre><code class="language-javascript">{
	"message_id": 1,
	"coordinates": {
		"x": 123,
		"y": 456
	},
	"user_id": 1001
}
</code></pre>

<p>I'll be transmitting this:</p>

<pre><code class="language-python">\x00\x00\x00\x01\x00\x00\x00{\x00\x00\x01\xc8\x00\x00\x03\xe9</code></pre>

<p>However this message will be automatically re-assembled on the other end so I can conveniently access properties by their names.</p>

<p>I haven't been able to find any open-source library that support efficient messaging over Web Sockets as described above. Once the game is release I hope to release the part of code that does message encoding &amp; decoding as a stand-alone library</p>

				 </article>
				 
				 
				 	
				 	<aside>
				 		<h2>Next: </h2><a href="/first-working-version.html">First working version</a>
				 	</aside>
				 	
				 
				 
			</main>
		</div>
		<div class="push"></div>
	</div>
	<footer role="contentinfo">
	<div class="social">
		<a href="http://twitter.com/tnajdek" class="twitter-icon"></a>
		<a href="https://plus.google.com/112496233047981712515" class="gplus-icon"></a>
		<a href="https://github.com/tnajdek" class="github-icon"></a>
	</div><div class="copy">
		<small>
			&copy; <time datetime="2014">2014</time>
			<span>Tom Najdek</span>
			|
			<a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>			
		</small>
	</div>
</footer>
	<script src="/js/main.js"></script>
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-46126772-1', 'archersgame.com');
	ga('send', 'pageview');
</script>
</body>
</html>